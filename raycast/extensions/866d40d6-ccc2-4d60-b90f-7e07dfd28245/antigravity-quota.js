"use strict";var v=Object.create;var y=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var E=(n,t)=>{for(var o in t)y(n,o,{get:t[o],enumerable:!0})},w=(n,t,o,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of C(t))!$.call(n,r)&&r!==o&&y(n,r,{get:()=>t[r],enumerable:!(e=x(t,r))||e.enumerable});return n};var M=(n,t,o)=>(o=n!=null?v(D(n)):{},w(t||!n||!n.__esModule?y(o,"default",{value:n,enumerable:!0}):o,n)),L=n=>w(y({},"__esModule",{value:!0}),n);var U={};E(U,{default:()=>k});module.exports=L(U);var a=require("@raycast/api"),p=require("react");var P=require("child_process"),T=require("util"),I=M(require("http")),h=(0,T.promisify)(P.exec),F="/exa.language_server_pb.LanguageServerService/GetUserStatus",N=5e3;function O(n){if(!n)return[];let t=[],o=n.split(`
`).map(e=>e.trim()).filter(Boolean);for(let e of o){let r=e.replace(/^\d+\s+\d+\s+/,""),s=r.match(/--extension_server_port[=\s]+(\d+)/i)||r.match(/--extension_server_port=(\d+)/i),i=r.match(/--csrf_token[=\s]+([a-zA-Z0-9-]+)/i)||r.match(/--csrf_token=([a-zA-Z0-9-]+)/i);if(/--app_data_dir\s+antigravity\b/i.test(r)||/--app_data_dir=antigravity\b/i.test(r)){let f=e.trim().split(/\s+/),m=parseInt(f[0]),c=s?Number(s[1]):null,l=i?i[1]:null;t.push({pid:m,port:c,token:l,cmd:r})}}return t}var b=process.platform==="win32";async function R(){try{let n=b?`powershell -Command "Get-WmiObject Win32_Process | Where-Object { $_.CommandLine -match 'language_server|antigravity' } | Select-Object ProcessId, ParentProcessId, CommandLine | ForEach-Object { Write-Output (\\"$($_.ProcessId) $($_.ParentProcessId) $($_.CommandLine)\\") }"`:"ps -ww -eo pid,ppid,args | grep -E 'language_server|antigravity' | grep -v grep || true",{stdout:t}=await h(n,{timeout:8e3});return O(t)}catch(n){return console.error("Error detecting process:",n),[]}}async function Q(n){if(b){let t=`netstat -ano | findstr "LISTENING" | findstr "${n}"`;try{let{stdout:o}=await h(t,{timeout:8e3}),e=[],r=o.split(`
`).filter(Boolean);for(let s of r){let i=s.match(/:(\d+)\s+/);if(i){let d=parseInt(i[1]);!isNaN(d)&&!e.includes(d)&&e.push(d)}}return e}catch{return[]}}else{let t=["/usr/sbin/lsof","/usr/bin/lsof","lsof"];for(let o of t){let e=`${o} -nP -iTCP -sTCP:LISTEN -a -p ${n} | grep LISTEN | awk '{print $9}' | cut -d: -f2`;try{let{stdout:r}=await h(e),s=r.split(`
`).map(i=>parseInt(i.trim())).filter(i=>!isNaN(i));if(s.length>0)return s}catch{}}return console.error(`All lsof attempts failed for pid ${n}`),[]}}function G(n,t,o,e,r){return new Promise((s,i)=>{let d=JSON.stringify(r||{}),f={hostname:n||"127.0.0.1",port:t,path:o,method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(d),"Connect-Protocol-Version":"1","X-Codeium-Csrf-Token":e||""},timeout:N,agent:!1},m=I.default.request(f,c=>{let l="";c.on("data",g=>l+=g),c.on("end",()=>{if(c.statusCode!==200)return i(new Error(`Status ${c.statusCode}`));try{s(JSON.parse(l))}catch{i(new Error("JSON error"))}})});m.on("error",c=>i(c)),m.on("timeout",()=>{m.destroy(),i(new Error("Timeout"))}),m.write(d),m.end()})}function B(n){let t=n,o=[];return t?.userStatus?.cascadeModelConfigData?.clientModelConfigs?o=t.userStatus.cascadeModelConfigData.clientModelConfigs:t?.models?o=t.models:Array.isArray(t)&&(o=t),o.map(e=>{let r=e.quotaInfo||e.quota||null,s=r?.remainingFraction??(typeof e.remainingFraction=="number"?e.remainingFraction:void 0),i=typeof s=="number"?Number((s*100).toFixed(2)):typeof e.remainingPercentage=="number"?e.remainingPercentage:null,d=r?.resetTime??e.resetTime??e.reset_time??null,f=d?new Date(d):null,m=Date.now();return{label:e.label||e.name||e.model||e.modelOrAlias&&e.modelOrAlias.model||"unknown",modelId:e.modelId||e.model||e.modelOrAlias&&e.modelOrAlias.model||"unknown",remainingFraction:typeof s=="number"?s:null,remainingPercentage:i,isExhausted:typeof s=="number"?s===0:!!e.isExhausted,resetTime:f,timeUntilReset:f?f.getTime()-m:null,raw:e}})}function q(n){let t=new Map;for(let e of n){let r=e.remainingFraction!==null?e.remainingFraction.toString():"nf",s=e.resetTime?e.resetTime.toISOString():"nr",i=r+"|"+s;t.has(i)||t.set(i,[]),t.get(i).push(e)}let o=[];for(let[e,r]of t.entries()){let s=r.map(m=>m.remainingPercentage).filter(m=>m!==null),i=s.length?Number((s.reduce((m,c)=>m+c,0)/s.length).toFixed(2)):null,d=r.find(m=>m.resetTime)?.resetTime??null,f=r.every(m=>m.isExhausted);o.push({key:e,models:r,remainingPercentage:i,resetTime:d,isExhausted:f})}return o}async function S(){let n=await R();if(n.length===0)throw new Error("Could not detect any Antigravity processes.");for(let t of n){let o=new Set;if(t.port&&o.add(t.port),(await Q(t.pid)).forEach(s=>o.add(s)),o.size===0)continue;let r={metadata:{ideName:"local",extensionName:"simple-client",locale:"en"}};for(let s of Array.from(o))try{let i=await G("127.0.0.1",s,F,t.token,r);if(i){let d=B(i);if(d.length>0)return q(d)}}catch{}}throw new Error("Could not fetch data from any process/port.")}function _(n){if(!n||n<=0)return"0s";let t=Math.floor(n/1e3),o=Math.floor(t/86400),e=Math.floor(t%86400/3600),r=Math.floor(t%3600/60),s=t%60;return o?`${o}d ${e}h`:e?`${e}h ${r}m`:r?`${r}m`:`${s}s`}function A(n){if(n===null)return{source:"circle-16",tintColor:"#888888"};let t=Math.max(0,Math.min(100,n)),o=7,e=2*Math.PI*o,r=e-t/100*e,s=t<=10?"#FF6363":t<=30?"#FFCC00":"#44DD66",i=`
    <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
      <circle cx="10" cy="10" r="${o}" fill="none" stroke="${s}" stroke-width="2" opacity="0.2" />
      <circle cx="10" cy="10" r="${o}" fill="none" stroke="${s}" stroke-width="2"
        stroke-dasharray="${e}"
        stroke-dashoffset="${r}"
        stroke-linecap="round"
        transform="rotate(-90 10 10)" />
    </svg>
  `.trim().replace(/\s+/g," ");return{source:`data:image/svg+xml,${encodeURIComponent(i)}`}}var u=require("react/jsx-runtime");function k(){let[n,t]=(0,p.useState)([]),[o,e]=(0,p.useState)(!0),[r,s]=(0,p.useState)(null),[i,d]=(0,p.useState)("percentage_asc");async function f(){e(!0),s(null);try{let c=await S();t(c)}catch(c){let l=c instanceof Error?c.message:String(c);l==="Could not detect any Antigravity processes."&&(l="Antigravity process not found. Please ensure the Antigravity IDE is running. If it is already open, try restarting it."),s(l),(0,a.showToast)({style:a.Toast.Style.Failure,title:"Failed to fetch quota",message:l})}finally{e(!1)}}(0,p.useEffect)(()=>{f()},[]);let m=(0,p.useMemo)(()=>{let c=[...n];return c.sort((l,g)=>i==="percentage_asc"?(l.remainingPercentage??1/0)-(g.remainingPercentage??1/0):i==="percentage_desc"?(g.remainingPercentage??-1/0)-(l.remainingPercentage??-1/0):i==="reset_asc"?(l.resetTime?.getTime()??1/0)-(g.resetTime?.getTime()??1/0):i==="reset_desc"?(g.resetTime?.getTime()??-1/0)-(l.resetTime?.getTime()??-1/0):0),c},[n,i]);if(r){let c=r.includes("Antigravity process not found");return(0,u.jsx)(a.List,{children:(0,u.jsx)(a.List.EmptyView,{icon:c?a.Icon.ExclamationMark:a.Icon.Warning,title:c?"Antigravity Not Detected":"Error Fetching Data",description:r,actions:(0,u.jsx)(a.ActionPanel,{children:(0,u.jsx)(a.Action,{title:"Retry",onAction:f})})})})}return(0,u.jsxs)(a.List,{isLoading:o,searchBarPlaceholder:"Filter models...",searchBarAccessory:(0,u.jsxs)(a.List.Dropdown,{tooltip:"Sort by",storeValue:!0,onChange:c=>d(c),children:[(0,u.jsxs)(a.List.Dropdown.Section,{title:"Remaining %",children:[(0,u.jsx)(a.List.Dropdown.Item,{title:"Least Remaining (Critical First)",value:"percentage_asc"}),(0,u.jsx)(a.List.Dropdown.Item,{title:"Most Remaining First",value:"percentage_desc"})]}),(0,u.jsxs)(a.List.Dropdown.Section,{title:"Reset Time",children:[(0,u.jsx)(a.List.Dropdown.Item,{title:"Resetting Soonest First",value:"reset_asc"}),(0,u.jsx)(a.List.Dropdown.Item,{title:"Resetting Latest First",value:"reset_desc"})]})]}),children:[n.length===0&&!o&&(0,u.jsx)(a.List.EmptyView,{icon:a.Icon.Bird,title:"No Quota Data Found",description:"Could not find any quota models from the running Antigravity process.",actions:(0,u.jsx)(a.ActionPanel,{children:(0,u.jsx)(a.Action,{title:"Retry",onAction:f})})}),m.map(c=>(0,u.jsx)(a.List.Section,{title:`Group (${c.remainingPercentage??"N/A"}%)`,subtitle:`Reset: ${c.resetTime?c.resetTime.toLocaleString():"N/A"}`,children:c.models.map(l=>(0,u.jsx)(a.List.Item,{icon:A(l.remainingPercentage),title:l.label,subtitle:l.remainingPercentage!==null?`${l.remainingPercentage}%`:"N/A",accessories:[{text:l.resetTime?`Reset in ${_(l.timeUntilReset)}`:""},{date:l.resetTime||void 0,tooltip:l.resetTime?.toLocaleString()}],actions:(0,u.jsxs)(a.ActionPanel,{children:[(0,u.jsx)(a.Action,{title:"Reload",onAction:f}),(0,u.jsx)(a.Action,{title:"Clear Cache & Retry",shortcut:{modifiers:["cmd","shift"],key:"r"},onAction:f})]})},l.modelId))},c.key))]})}
